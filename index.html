<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Castillo Sabor">
<meta name="theme-color" content="#4338ca">
<link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/castle.png">
<link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/castle.png">
<title>EL CASTILLO DEL SABOR ğŸ° v37</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter',sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none;}
.app-container{max-width:600px;margin:0 auto; min-height: 100vh; background-color: #f3f4f6;}
.log-item,.producto-item{animation:slideIn .3s ease-out}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.search-results-popover{max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;position:absolute;z-index:50;width:100%;background:#fff;box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);}
.search-results-popover div{padding:.75rem 1rem;cursor:pointer;border-bottom:1px solid #f3f4f6;}
.search-results-popover div:hover{background-color:#eef2ff;color:#4338ca;font-weight:500;}
.nav-btn{flex:1;padding:.5rem .1rem;font-size:.75rem;border-radius:.5rem;text-align:center;transition:all 0.2s;font-weight:500;}
.nav-btn-active{background-color:#4f46e5;color:#fff;box-shadow:0 2px 4px rgba(79,70,229,0.3);}
.nav-btn-inactive{background-color:#fff;color:#6b7280;border:1px solid #e5e7eb;}
.filter-btn{flex:1;padding:.4rem;font-size:.75rem;border-radius:.375rem;text-align:center;border:1px solid #e0e7ff;white-space:nowrap;}
.filter-btn-active{background-color:#4f46e5;color:#fff;border-color:#4338ca;}
.filter-btn-inactive{background-color:#fff;color:#4f46e5;}
.query-shortcut-btn{flex-grow:1;padding:.5rem;font-size:.8rem;border-radius:.375rem;background-color:#e0e7ff;color:#3730a3;font-weight:600;}
.modal{position:fixed;inset:0;background-color:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100;padding:1rem;backdrop-filter:blur(2px);}
@media print{body>*{display:none!important}#app-wrapper{display:block!important;position:absolute;top:0;left:0;width:100%;margin:0;padding:0;background:white!important}.no-print{display:none!important}#reporte-resultados-wrapper{display:block!important;box-shadow:none!important;border:none!important}#reporte-resultados,.bg-white{background-color:#fff!important;color:#000!important;border:none!important}body.print-receipt{width:80mm}body.print-receipt #app-wrapper{width:80mm}body.print-receipt .log-item{border-bottom:1px dashed #000;font-size:12px}}
</style>
</head>
<body class="bg-gray-100 text-gray-900 select-none">

<!-- Alerta de error de Firebase -->
<div id="firebase-error-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[200] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center space-y-4 shadow-2xl border-b-4 border-red-500">
        <div class="text-5xl">âš ï¸</div>
        <h2 class="text-xl font-bold text-red-600">Error de Sistema</h2>
        <p class="text-gray-600 text-sm">Hubo un problema iniciando la base de datos.</p>
        <div class="bg-red-50 p-3 rounded text-left text-xs text-red-800 border border-red-200 font-mono" id="firebase-error-text"></div>
        <button onclick="location.reload()" class="w-full py-2 bg-gray-800 text-white rounded-lg font-bold mt-3">Reintentar</button>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="bg-white p-5 rounded-2xl shadow-2xl w-full max-w-xs space-y-4">
        <h3 class="text-lg font-bold text-gray-800">Editar Monto</h3>
        <p id="edit-modal-desc" class="text-sm text-gray-500 font-medium">...</p>
        <input type="number" id="edit-modal-monto" class="block w-full px-4 py-3 border-2 border-indigo-100 rounded-xl text-lg font-bold text-center focus:border-indigo-500 outline-none" onfocus="this.select()">
        <div class="flex gap-3"><button id="edit-modal-cancel-btn" class="flex-1 py-2 bg-gray-100 rounded-xl">Cancelar</button><button id="edit-modal-save-btn" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold">Guardar</button></div>
    </div>
</div>

<div id="sync-modal" class="modal">
    <div class="bg-white p-5 rounded-2xl shadow-2xl w-full max-w-xs space-y-4">
        <div class="flex items-center gap-2 text-indigo-600"><span class="text-2xl">â˜ï¸</span><h3 class="text-lg font-bold">Sincronizar</h3></div>
        <p class="text-gray-500 text-xs">ID Maestro del dispositivo principal:</p>
        <input type="text" id="sync-id-input" class="block w-full px-3 py-2 border-2 border-gray-200 rounded-lg font-mono text-center text-sm focus:border-indigo-500 outline-none" placeholder="Pegar ID aquÃ­">
        <div class="flex gap-3"><button id="sync-modal-cancel-btn" class="flex-1 py-2 bg-gray-100 rounded-xl">Cerrar</button><button id="sync-modal-save-btn" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold">Conectar</button></div>
    </div>
</div>

<div id="app-wrapper" class="app-container p-3 pb-24">
    <header class="mb-3 no-print flex flex-col gap-2">
        <div class="flex justify-between items-center">
            <div><h1 class="text-2xl font-extrabold text-indigo-800 tracking-tight">EL CASTILLO ğŸ°</h1><p class="text-xs text-indigo-500 font-medium">v37 <span class="text-gray-400">|</span> <span id="fecha-actual"></span></p></div>
            <div id="auth-status" class="text-right flex items-center gap-2">
                <div class="flex flex-col items-end"><div id="sync-status-msg" class="hidden inline-block px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded-full mb-1">â— ONLINE</div><span id="user-id-full" class="font-mono text-xs text-gray-700 font-medium bg-white px-1 rounded border border-gray-200">...</span></div>
                <button id="sync-btn" class="w-8 h-8 flex items-center justify-center text-xl bg-white border border-indigo-200 text-indigo-600 rounded-lg shadow-sm">âš™ï¸</button>
            </div>
        </div>
    </header>

    <div class="flex gap-1 mb-3 bg-white p-1 rounded-xl shadow-sm border border-gray-100 no-print sticky top-0 z-40">
        <button id="goto-bitacora-btn" class="nav-btn nav-btn-active">ğŸ’° Caja</button>
        <button id="goto-gastos-generales-btn" class="nav-btn nav-btn-inactive">ğŸ“‰ Gastos</button>
        <button id="goto-productos-btn" class="nav-btn nav-btn-inactive">ğŸ“‹ Prod</button>
        <button id="goto-empleados-btn" class="nav-btn nav-btn-inactive">ğŸ‘· Emp</button>
        <button id="goto-resumenes-btn" class="nav-btn nav-btn-inactive">ğŸ“Š Report</button>
    </div>

    <div id="bitacora-view" class="space-y-3">
        <form id="cierre-form" class="space-y-3">
            <section class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <div class="flex items-center justify-between mb-2"><h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">1. Gastos / NÃ³mina</h2><span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">Diario</span></div>
                <div class="relative mb-2"><input type="text" id="gasto-search" placeholder="ğŸ” Buscar producto o empleado..." class="w-full pl-8 px-3 py-2.5 bg-gray-50 border-none rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"><span class="absolute left-3 top-2.5 text-gray-400 text-sm">ğŸ”</span><div id="search-results" class="hidden search-results-popover rounded-b-lg shadow-xl"></div></div>
                <div class="flex gap-2 items-center"><input type="text" id="gasto-desc" placeholder="DescripciÃ³n" class="flex-[2] px-3 py-2 border border-gray-200 rounded-lg text-sm outline-none" readonly><input type="number" id="gasto-cantidad" placeholder="#" class="w-10 px-1 py-2 border border-gray-200 rounded-lg text-sm text-center hidden bg-yellow-50"><input type="number" id="gasto-monto" placeholder="$0" class="flex-1 px-2 py-2 border border-gray-200 rounded-lg text-sm font-bold text-gray-700 focus:border-indigo-500 outline-none"><button type="button" id="add-gasto-btn" class="w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center shadow-md text-xl font-bold">+</button></div>
                <div id="lista-gastos" class="mt-3 space-y-2 max-h-48 overflow-y-auto pr-1"></div>
            </section>
            <section class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2">2. Retiros de Caja</h2>
                <div class="flex gap-2"><input type="text" id="retiro-desc" placeholder="Motivo" class="flex-[2] px-3 py-2 border border-gray-200 rounded-lg text-sm"><input type="number" id="retiro-monto" placeholder="$0" class="flex-1 px-2 py-2 border border-gray-200 rounded-lg text-sm font-bold"><button type="button" id="add-retiro-btn" class="w-10 h-10 bg-blue-500 text-white rounded-lg flex items-center justify-center shadow-md text-xl font-bold">+</button></div>
                <div id="lista-retiros" class="mt-3 space-y-1"></div>
            </section>
            <section class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2">3. Arqueo Final</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 p-2 rounded-lg border border-gray-100"><label class="text-[10px] text-gray-500 uppercase font-bold">Base Fija</label><div id="base-fija-display" class="text-lg font-bold text-gray-700">200.000</div></div>
                    <div class="bg-white p-0 rounded-lg"><label class="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Efectivo en Caja</label><input type="number" id="efectivo-final" class="w-full px-3 py-2 border-2 border-green-100 rounded-lg text-lg font-bold text-green-700 bg-green-50" placeholder="0"></div>
                    <div class="col-span-2"><label class="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Pagos Digitales</label><input type="number" id="pagos-digitales" class="w-full px-3 py-2 border-2 border-purple-100 rounded-lg text-lg font-bold text-purple-700 bg-purple-50" placeholder="0"></div>
                </div>
            </section>
            <section class="bg-gray-900 text-white p-4 rounded-2xl shadow-lg no-print text-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 opacity-10 text-6xl">ğŸ°</div>
                <div class="space-y-1 relative z-10">
                    <div class="flex justify-between text-gray-300 text-xs"><span>Total Gastos:</span><span id="resumen-gastos" class="text-red-300 font-mono">0</span></div>
                    <div class="flex justify-between text-gray-300 text-xs"><span>Total Retiros:</span><span id="resumen-retiros" class="text-blue-300 font-mono">0</span></div>
                    <div class="h-px bg-gray-700 my-2"></div>
                    <div class="flex justify-between"><span>Ventas Efec:</span><span id="resumen-ventas-efectivo" class="text-green-400 font-mono font-bold">0</span></div>
                    <div class="flex justify-between"><span>Ventas Dig:</span><span id="resumen-ventas-digital" class="text-purple-400 font-mono font-bold">0</span></div>
                    <div class="flex justify-between items-end mt-2 pt-2 border-t border-gray-700"><span class="font-bold text-gray-400 pb-1">TOTAL</span><span id="resumen-venta-total" class="text-2xl font-bold text-white tracking-tight">0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>Ganancia Neta:</span><span id="resumen-ganancia-neta">0</span></div>
                </div>
            </section>
            <button type="button" id="save-cierre-btn" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold shadow-lg no-print flex justify-center items-center gap-2 text-lg"><span>ğŸ’¾</span> Guardar DÃ­a</button>
            <p id="save-message" class="text-center text-green-600 text-sm font-bold h-5 no-print"></p>
        </form>
        <div class="mt-8 no-print"><h3 class="font-bold text-gray-400 text-xs uppercase mb-2">Historial Reciente</h3><div id="historial-lista" class="space-y-2 text-sm opacity-80"></div></div>
    </div>

    <div id="gastos-generales-view" class="hidden space-y-3">
        <form id="gasto-general-form" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
            <h3 class="font-bold text-gray-800">Nuevo Gasto General</h3>
            <div id="gasto-general-filter-buttons" class="flex gap-1 text-xs overflow-x-auto pb-1 no-scrollbar">
                <button type="button" class="filter-btn filter-btn-active min-w-[50px]" data-categoria="Todos">Todos</button><button type="button" class="filter-btn filter-btn-inactive min-w-[50px]" data-categoria="Negocio">Negocio</button><button type="button" class="filter-btn filter-btn-inactive min-w-[50px]" data-categoria="Hogar">Hogar</button><button type="button" class="filter-btn filter-btn-inactive min-w-[50px]" data-categoria="Personal">Pers</button><button type="button" class="filter-btn filter-btn-inactive min-w-[50px]" data-categoria="Otros">Otros</button>
            </div>
            <div class="relative"><input type="text" id="gasto-general-search" placeholder="ğŸ” Buscar concepto..." class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm"><div id="gasto-general-search-results" class="hidden search-results-popover rounded-lg shadow-lg"></div></div>
            <input type="text" id="gasto-general-desc" placeholder="DescripciÃ³n" class="w-full px-3 py-2 border border-gray-200 rounded-lg" required>
            <div class="flex gap-2"><select id="gasto-general-categoria" class="flex-1 px-2 py-2 border border-gray-200 rounded-lg bg-white text-sm"><option>Negocio</option><option>Hogar</option><option>Personal</option><option>Otros</option></select><input type="number" id="gasto-general-monto" placeholder="$ Monto" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg font-bold"></div>
            <button type="submit" id="save-gasto-general-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md">Registrar Gasto</button>
            <p id="gasto-general-save-message" class="text-center text-sm text-green-600 h-5"></p>
        </form>
        <div id="lista-gastos-generales" class="mt-4 space-y-2 text-sm pb-10"></div>
    </div>

    <div id="productos-view" class="hidden space-y-3">
        <form id="producto-form" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
            <div class="flex justify-between items-center"><h3 id="producto-form-title" class="font-bold text-gray-800">Gestionar Productos</h3><button type="button" id="clear-producto-form-btn" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Limpiar</button></div>
            <input type="hidden" id="producto-id">
            <div class="relative"><input type="text" id="producto-manage-search" placeholder="ğŸ” Buscar para editar..." class="w-full px-3 py-2 bg-gray-50 border rounded-lg text-sm"><div id="producto-manage-search-results" class="hidden search-results-popover rounded-lg shadow-lg"></div></div>
            <div class="p-3 bg-gray-50 rounded-lg border border-gray-100 space-y-2">
                <input type="text" id="producto-nombre" placeholder="Nombre" class="w-full px-3 py-2 border rounded-lg text-sm font-medium" required>
                <div class="flex gap-2">
                    <select id="producto-tipo" class="w-1/2 px-2 py-2 border rounded-lg text-sm bg-white"><option value="variable">Precio Variable</option><option value="fijo">Precio Fijo</option></select>
                    <div id="producto-precio-wrapper" class="hidden w-1/2"><input type="number" id="producto-precio" placeholder="$ Precio" class="w-full px-3 py-2 border rounded-lg text-sm font-bold"></div>
                </div>
            </div>
            <div class="text-xs font-bold text-gray-500 uppercase mt-2">Proveedores</div>
            <div id="proveedores-en-formulario-lista" class="text-xs space-y-1 bg-white border rounded-lg p-1 min-h-[20px]"></div>
            <div class="flex gap-1"><input id="prov-nom" placeholder="Nom" class="flex-[2] border rounded px-2 py-1 text-sm"><input id="prov-tel" placeholder="Tel" class="flex-1 border rounded px-2 py-1 text-sm"><button type="button" id="add-proveedor-btn" class="bg-blue-100 text-blue-600 px-3 rounded font-bold">+</button></div>
            <div class="flex gap-2 mt-2 pt-2 border-t"><button type="button" id="delete-producto-btn" class="hidden w-10 bg-red-100 text-red-600 rounded-lg font-bold">ğŸ—‘ï¸</button><button type="submit" id="save-producto-btn" class="flex-1 bg-green-600 text-white py-2.5 rounded-lg font-bold shadow-sm">Guardar</button></div>
            <p id="producto-save-message" class="text-center text-sm text-green-600 h-4"></p>
        </form>
        <div id="lista-productos" class="mt-4 space-y-2 text-sm pb-10"></div>
    </div>

    <div id="empleados-view" class="hidden space-y-3">
        <form id="empleado-form" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
            <h3 id="empleado-form-title" class="font-bold text-gray-800">NÃ³mina / Empleados</h3>
            <input type="hidden" id="empleado-id">
            <input type="text" id="empleado-nombre" placeholder="Nombre" class="w-full px-3 py-2 border rounded-lg" required>
            <input type="number" id="empleado-sueldo" placeholder="Sueldo Diario ($)" class="w-full px-3 py-2 border rounded-lg font-bold text-gray-700">
            <div class="flex gap-2"><button type="button" id="cancel-edit-empleado-btn" class="hidden flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg">Cancelar</button><button type="submit" id="save-empleado-btn" class="flex-1 bg-green-600 text-white py-2.5 rounded-lg font-bold shadow-sm">Guardar</button></div>
            <p id="empleado-save-message" class="text-center text-sm text-green-600 h-4"></p>
        </form>
        <div id="lista-empleados" class="mt-4 space-y-2 text-sm"></div>
    </div>

    <div id="resumenes-view" class="hidden space-y-4">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 no-print">
            <h3 class="font-bold text-gray-800 mb-3">Consultar Historial</h3>
            <div class="grid grid-cols-4 gap-2 mb-3"><button class="query-shortcut-btn" data-range="today">Hoy</button><button class="query-shortcut-btn" data-range="this_month">Mes</button><button class="query-shortcut-btn" data-range="last_month">Mes Ant.</button><button class="query-shortcut-btn" data-range="this_year">AÃ±o</button></div>
            <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-lg mb-3"><input type="date" id="reporte-fecha-inicio" class="bg-white border border-gray-200 rounded px-2 py-1 w-full text-xs"><span class="text-gray-400">â</span><input type="date" id="reporte-fecha-fin" class="bg-white border border-gray-200 rounded px-2 py-1 w-full text-xs"></div>
            <button id="query-rango-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Generar Reporte</button>
        </div>
        <div id="reporte-resultados-wrapper" class="hidden space-y-4 pb-12">
            <h2 id="reporte-resultados-header" class="text-lg font-bold text-center text-gray-800 bg-indigo-50 py-2 rounded-lg border border-indigo-100"></h2>
            <div class="no-print bg-white p-3 rounded-xl mb-2 space-y-2 border border-gray-200">
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Opciones</div>
                <div class="flex gap-2"><button id="print-carta-btn" class="flex-1 bg-white border border-blue-200 text-blue-600 py-2 rounded-lg text-sm font-bold">ğŸ“„ Carta PDF</button><button id="print-recibo-btn" class="flex-1 bg-gray-800 text-white py-2 rounded-lg text-sm font-bold">ğŸ§¾ Recibo</button></div>
            </div>
            <div id="print-section-resumen" class="bg-gray-900 text-white p-5 rounded-xl shadow-md"><h4 class="text-xs text-gray-400 uppercase mb-2">Balance</h4><div id="reporte-resultados" class="space-y-1"></div></div>
            <div id="print-section-analisis" class="bg-white p-4 rounded-xl border border-gray-200"><h3 class="font-bold mb-3 text-indigo-800 border-b pb-2 text-sm uppercase">ğŸ† Top Gastos</h3><div id="reporte-analisis-gastos" class="space-y-2"></div></div>
            <div id="print-section-detalle" class="bg-white p-4 rounded-xl border border-gray-200"><h3 class="font-bold mb-3 text-indigo-800 border-b pb-2 text-sm uppercase">ğŸ“ Movimientos</h3><div id="reporte-detalle-movimientos" class="space-y-1 max-h-96 overflow-y-auto"></div></div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, deleteDoc, onSnapshot, collection, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCFsgLCSCnpbY77NqoaXHzG5HrmCfqlRVE",
  authDomain: "castillo-sabor-app.firebaseapp.com",
  projectId: "castillo-sabor-app",
  storageBucket: "castillo-sabor-app.firebasestorage.app",
  messagingSenderId: "485212277264",
  appId: "1:485212277264:web:2f7068625535fc1d261895"
};

const appId = 'castillo-sabor-prod';
const BASE = 200000;
const MASTER_KEY = 'masterUserId';

const PRE_GASTOS = [{nombre:"Naranjas",tipo:"variable"},{nombre:"BuÃ±uelos",tipo:"fijo",precio:1000},{nombre:"Carne",tipo:"variable"},{nombre:"Pollo",tipo:"variable"},{nombre:"Verduras",tipo:"variable"},{nombre:"Mora",tipo:"variable"},{nombre:"Avena",tipo:"fijo",precio:5000},{nombre:"Servilletas",tipo:"fijo",precio:3000},{nombre:"Bolsas",tipo:"fijo",precio:2000},{nombre:"JabÃ³n",tipo:"fijo",precio:6000},{nombre:"Cloro",tipo:"fijo",precio:4000},{nombre:"CafÃ©",tipo:"variable"},{nombre:"AzÃºcar",tipo:"fijo",precio:4500},{nombre:"Queso",tipo:"variable"},{nombre:"Harina Trigo",tipo:"fijo",precio:4500},{nombre:"Harina MaÃ­z",tipo:"fijo",precio:4200},{nombre:"Sal",tipo:"fijo",precio:1500},{nombre:"Leche",tipo:"fijo",precio:4800},{nombre:"Huevos",tipo:"variable"},{nombre:"Vasos",tipo:"fijo",precio:3000}];
const PRE_GEN = [{desc:"Arriendo",cat:"Negocio"},{desc:"Luz Local",cat:"Negocio"},{desc:"Agua Local",cat:"Negocio"},{desc:"Gas Local",cat:"Negocio"},{desc:"Luz Hogar",cat:"Hogar"},{desc:"Internet",cat:"Hogar"},{desc:"Celular",cat:"Personal"},{desc:"Salud",cat:"Personal"}];

let db,auth,userId,activeId,colCierres,colProd,colEmp,colGen;
let subReporte,subHist,subProd,subEmp,subGen;
let localProd=[],localEmp=[],localGen=[],gastos=[],retiros=[],curProv=[];
let selItem=null,seeding=false,curCat="Todos";

const $ = id => document.getElementById(id);
const fmtNum = n => new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(n||0);
const fmtTime = d => new Date(d).toLocaleTimeString('es-CO',{hour:'numeric',minute:'2-digit'});
const norm = s => s?s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():'';

async function init(){
    try {
        const app=initializeApp(firebaseConfig); 
        db=getFirestore(app); 
        auth=getAuth(app);
        
        // Calculamos la fecha aquÃ­ para asegurar que no estÃ© vacÃ­a
        const today = new Date();
        const isoDate = today.toISOString().split('T')[0];
        $('fecha-actual').textContent = today.toLocaleDateString('es-CO');
        $('fecha-actual').dataset.iso = isoDate;

        await signInAnonymously(auth).catch(err => {
            console.error("Error de Auth:", err);
            document.getElementById('firebase-error-text').textContent = err.code || err.message;
            document.getElementById('firebase-error-modal').classList.remove('hidden');
        });

        onAuthStateChanged(auth,u=>{
            if(u){
                let storedId = localStorage.getItem(MASTER_KEY);
                if (!storedId) {
                    storedId = u.uid;
                    localStorage.setItem(MASTER_KEY, storedId);
                }
                activeId = storedId;
                $('user-id-full').textContent = activeId; 
                $('sync-status-msg').classList.remove('hidden');
                
                const path=`artifacts/${appId}/users/${activeId}`;
                colCierres=collection(db,`${path}/cierres_v2`); colProd=collection(db,`${path}/productos`);
                colEmp=collection(db,`${path}/empleados`); colGen=collection(db,`${path}/gastos_gen`);
                
                // Pasamos la fecha calculada explÃ­citamente
                setupSubs(isoDate);
            }
        });
    } catch(e) {
        console.error("Error General:", e);
        document.getElementById('firebase-error-text').textContent = e.message;
        document.getElementById('firebase-error-modal').classList.remove('hidden');
    }
}

function setupSubs(currentIsoDate){
    if(subReporte)subReporte();
    
    // Usamos la fecha que pasamos o leemos del DOM como respaldo, pero aseguramos que no sea vacÃ­a
    const docId = currentIsoDate || $('fecha-actual').dataset.iso || new Date().toISOString().split('T')[0];
    
    subReporte=onSnapshot(doc(colCierres, docId), s=>{
        const d=s.data()||{}; $('efectivo-final').value=d.ef||''; $('pagos-digitales').value=d.dig||'';
        gastos=d.gastos||[]; retiros=d.retiros||[]; renderBitacora();
    }, err => console.log("Esperando datos..."));

    if(subProd)subProd();
    subProd=onSnapshot(query(colProd),async s=>{
        localProd=[]; s.forEach(d=>localProd.push({id:d.id,...d.data()}));
        if(!localProd.length && !seeding){seeding=true;const b=writeBatch(db);PRE_GASTOS.forEach(p=>b.set(doc(colProd),p));await b.commit();}
        renderProd();
    }, err => {});

    if(subEmp)subEmp();
    subEmp=onSnapshot(query(colEmp),s=>{localEmp=[];s.forEach(d=>localEmp.push({id:d.id,...d.data()}));renderEmp();}, err => {});
    if(subGen)subGen();
    subGen=onSnapshot(query(colGen),s=>{localGen=[];s.forEach(d=>localGen.push({id:d.id,...d.data()}));renderGen();}, err => {});
    if(subHist)subHist();
    subHist=onSnapshot(query(colCierres),s=>{let h=[];s.forEach(d=>h.push({id:d.id,...d.data()}));$('historial-lista').innerHTML=h.sort((a,b)=>b.id.localeCompare(a.id)).slice(0,5).map(r=>`<div class="bg-white p-2 rounded-lg border border-gray-100 flex justify-between items-center"><span class="font-mono text-gray-500">${r.id.slice(5)}</span><span class="font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded-md">${fmtNum(r.neto)}</span></div>`).join('');}, err => {});
}

function renderBitacora(){
    const ef=Number($('efectivo-final').value), dig=Number($('pagos-digitales').value);
    const tg=gastos.reduce((s,i)=>s+i.m,0), tr=retiros.reduce((s,i)=>s+i.m,0);
    const venEf=(ef-BASE)+tg+tr; const tot=(venEf>0?venEf:0)+dig;
    $('lista-gastos').innerHTML=gastos.map(g=>`<div class="flex justify-between items-center border-b border-gray-50 p-2 text-sm hover:bg-gray-50 rounded transition-colors"><div class="flex flex-col leading-tight"><span class="font-medium text-gray-800">${g.desc}</span><span class="text-[10px] text-gray-400">${fmtTime(g.h)}</span></div><div class="flex items-center gap-2"><span class="font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded">${fmtNum(g.m)}</span><button onclick="window.editItem('${g.id}','g')" class="text-indigo-400 hover:text-indigo-600 p-1">âœ</button><button onclick="window.delItem('${g.id}','g')" class="text-red-300 hover:text-red-500 p-1 font-bold">Ã—</button></div></div>`).join('');
    $('lista-retiros').innerHTML=retiros.map(r=>`<div class="flex justify-between items-center border-b border-gray-50 p-2 text-sm hover:bg-gray-50 rounded transition-colors"><div class="flex flex-col leading-tight"><span class="font-medium text-gray-800">${r.desc}</span></div><div class="flex items-center gap-2"><span class="font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded">${fmtNum(r.m)}</span><button onclick="window.editItem('${r.id}','r')" class="text-indigo-400 hover:text-indigo-600 p-1">âœ</button><button onclick="window.delItem('${r.id}','r')" class="text-red-300 hover:text-red-500 p-1 font-bold">Ã—</button></div></div>`).join('');
    $('resumen-gastos').textContent=fmtNum(tg); $('resumen-retiros').textContent=fmtNum(tr);
    $('resumen-ventas-efectivo').textContent=fmtNum(venEf>0?venEf:0); $('resumen-ventas-digital').textContent=fmtNum(dig);
    $('resumen-venta-total').textContent=fmtNum(tot); $('resumen-ganancia-neta').textContent=fmtNum(tot-tg);
}

window.saveCierre=async()=>{
    const ef=Number($('efectivo-final').value), dig=Number($('pagos-digitales').value);
    const tg=gastos.reduce((s,i)=>s+i.m,0), tr=retiros.reduce((s,i)=>s+i.m,0);
    const venEf=(ef-BASE)+tg+tr; const tot=(venEf>0?venEf:0)+dig;
    await setDoc(doc(colCierres,$('fecha-actual').dataset.iso),{ef,dig,gastos,retiros,tg,tr,venEf:venEf>0?venEf:0,tot,neto:tot-tg},{merge:true});
    $('save-message').textContent="âœ“ Guardado correctamente"; setTimeout(()=>$('save-message').textContent="",2500);
};

window.addItem=(type)=>{
    if(type==='g'&&(!selItem||selItem.tipo==='nomina')) return;
    const desc=type==='g'?$('gasto-desc').value:$('retiro-desc').value;
    const m=Number($(type==='g'?'gasto-monto':'retiro-monto').value);
    if(!desc||m<=0)return;
    const item={id:Date.now()+'',desc:desc+(type==='g'&&$('gasto-cantidad').value>0?` (x${$('gasto-cantidad').value})`:''),m,h:new Date().toISOString()};
    if(type==='g')gastos.push(item);else retiros.push(item);
    if(type==='g'){$('gasto-desc').value='';$('gasto-monto').value='';$('gasto-cantidad').classList.add('hidden');$('gasto-monto').readOnly=false;$('gasto-search').focus();selItem=null;}
    else{$('retiro-desc').value='';$('retiro-monto').value='';}
    renderBitacora(); window.saveCierre();
};

window.delItem=(id,type)=>{if(type==='g')gastos=gastos.filter(i=>i.id!=id);else retiros=retiros.filter(i=>i.id!=id);renderBitacora();window.saveCierre();};
window.editItem=(id,type)=>{
    const item=(type==='g'?gastos:type==='r'?retiros:localGen).find(i=>i.id===id);
    if(!item)return;
    $('edit-modal').style.display='flex';$('edit-modal').dataset.id=id;$('edit-modal').dataset.type=type;
    $('edit-modal-desc').textContent=item.desc||item.d||item.descripcion;$('edit-modal-monto').value=item.m||item.monto;
    $('edit-modal-monto').focus();
};

$('edit-modal-save-btn').onclick=async()=>{
    const id=$('edit-modal').dataset.id, type=$('edit-modal').dataset.type, m=Number($('edit-modal-monto').value);
    if(type==='gen')await setDoc(doc(colGen,id),{m},{merge:true});
    else{const l=type==='g'?gastos:retiros;const i=l.find(x=>x.id===id);if(i)i.m=m;renderBitacora();window.saveCierre();}
    $('edit-modal').style.display='none';
};

$('gasto-search').oninput=(e)=>{
    const q=norm(e.target.value), res=$('search-results'); res.innerHTML='';
    if(!q){res.classList.add('hidden');return;}
    [...localProd.map(p=>({...p,l:p.nombre})),...localEmp.map(e=>({...e,l:`NÃ³mina: ${e.nombre}`,tipo:'nomina',precio:e.sueldo}))]
    .filter(x=>norm(x.l).includes(q)).forEach(x=>{
        const d=document.createElement('div'); d.innerHTML=`<div class="font-medium text-gray-800">${x.l}</div>${x.tipo==='nomina'?'<div class="text-xs text-green-600">Empleado</div>':'<div class="text-xs text-indigo-500">Producto</div>'}`;
        d.onclick=()=>{
            selItem=x; $('gasto-search').value=''; res.classList.add('hidden');
            if(x.tipo==='nomina'){gastos.push({id:Date.now()+'',desc:x.l,m:x.precio,h:new Date().toISOString()});renderBitacora();window.saveCierre();}
            else{$('gasto-desc').value=x.nombre;$('gasto-monto').value=x.precio||'';
                 if(x.tipo==='fijo'){$('gasto-cantidad').classList.remove('hidden');$('gasto-cantidad').value=1;$('gasto-monto').readOnly=true;}
                 else{$('gasto-cantidad').classList.add('hidden');$('gasto-monto').readOnly=false;}$('gasto-monto').focus();
            }
        }; res.appendChild(d);
    }); res.classList.remove('hidden');
};

$('query-rango-btn').onclick=async()=>{
    const ini=$('reporte-fecha-inicio').value, fin=$('reporte-fecha-fin').value;
    $('reporte-resultados-header').textContent=`Reporte: ${ini} a ${fin}`;
    const [sC,sG]=await Promise.all([getDocs(query(colCierres,where('__name__','>=',ini),where('__name__','<=',fin))),getDocs(query(colGen,where('fecha','>=',ini),where('fecha','<=',fin)))]);
    const rep=[],gen=[];sC.forEach(d=>rep.push(d.data()));sG.forEach(d=>gen.push(d.data()));
    const totC=rep.reduce((a,b)=>a+(b.neto||0),0), totG=gen.reduce((a,b)=>a+b.m,0);
    $('reporte-resultados').innerHTML=`<div class="flex justify-between border-b border-gray-700 pb-2"><span>Operativo Neto:</span><span class="font-bold">${fmtNum(totC)}</span></div><div class="flex justify-between border-b border-gray-700 py-2"><span>Gastos Generales:</span><span class="text-red-400 font-bold">- ${fmtNum(totG)}</span></div><div class="flex justify-between pt-2 text-xl font-bold text-green-400"><span>Utilidad Real:</span><span>${fmtNum(totC-totG)}</span></div>`;
    const map={}; rep.forEach(r=>(r.gastos||[]).forEach(g=>{const n=g.desc.split(' (')[0];map[n]=(map[n]||0)+g.m;})); gen.forEach(g=>{map[g.d]=(map[g.d]||0)+g.m;});
    $('reporte-analisis-gastos').innerHTML=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k,v])=>`<div class="flex justify-between text-sm border-b border-gray-50 py-1"><span>${k}</span><span class="font-medium">${fmtNum(v)}</span></div>`).join('');
    const movs=[]; rep.forEach(r=>(r.gastos||[]).forEach(g=>movs.push({d:g.desc,m:g.m,t:'Diario',h:g.h}))); gen.forEach(g=>movs.push({d:g.d,m:g.m,t:'General',h:g.h}));
    $('reporte-detalle-movimientos').innerHTML=movs.sort((a,b)=>a.h.localeCompare(b.h)).map(m=>`<div class="flex justify-between text-xs border-b border-gray-50 py-1"><div><span class="font-medium text-gray-700">${m.d}</span> <span class="text-[9px] text-gray-400 bg-gray-100 px-1 rounded">${m.t}</span></div><span class="font-medium">${fmtNum(m.m)}</span></div>`).join('');
    $('reporte-resultados-wrapper').classList.remove('hidden');
    document.querySelector('#resumenes-view').scrollTo({top: 500, behavior: 'smooth'});
};
document.querySelectorAll('.query-shortcut-btn').forEach(btn=>{btn.onclick=()=>{
    const r=btn.dataset.range, t=new Date(); let s=new Date(t), e=new Date(t);
    if(r==='this_month')s=new Date(t.getFullYear(),t.getMonth(),1);
    else if(r==='last_month'){s=new Date(t.getFullYear(),t.getMonth()-1,1);e=new Date(t.getFullYear(),t.getMonth(),0);}
    else if(r==='this_year')s=new Date(t.getFullYear(),0,1);
    $('reporte-fecha-inicio').value=s.toISOString().split('T')[0]; $('reporte-fecha-fin').value=e.toISOString().split('T')[0]; $('query-rango-btn').click();
}});
$('print-recibo-btn').onclick=()=>{document.body.className='print-receipt';window.print();};
$('print-carta-btn').onclick=()=>{document.body.className='';window.print();};

init();
</script>
</body>
</html>